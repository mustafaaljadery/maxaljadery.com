# Design a Rate Limiter

A rate-limiter is an application that limits the user's ability to send requests to the server. It is used to protect a server from DDoS attacks or lower server load.

## Functional Requirements
- Users can send requests to the server. 
- The server should limit the number of requests a user can send in a given time window.

## Non-functional Requirements
- High availability
- Low latency
- Scalable
- Highly consistent 

## Back-of-the-envelope estimation
- 10 million users
- 10,000 requests per second
- <key, value> pair is about 100 bytes ~1GB

## High Level Design

<img src="/system-design/rate-limiter-highlevel.png" />

### Database
- You want to use a <key, value> database.
- We want to store everything in memory, disk will take way to long to access. 
- There is not a lot of data to store. We only store the userid and the number of requests within that time interval. (We can scale a single Redis instance vertically to suppot our workload.)
  - The only problem possibly here is the number of read requests per second we can use in a single memory store.
- We are going to use Redis because it is a fast in-memory database. We get acceess to our data very quickly and scales well.

## Deep Dive

<img src="/system-design/rate-limiter-deep-dive.png" />

### Algorithm
**Leaky bucket algorithm.**
- The idea is you have a bucket, similar of the with water. If the bucket is full then all excess water will leak out.
- Your token bucket is empty at every time interval, if it is filled to the top, each new request will be timeouted / rejected.

### Availability
- To ensure very high availability, we repliate our redis instances twice.

## Tradeoffs, bottlenecks, and summary

### Tradeoffs
- We can use something like a presistent database like MySQL, but we will have to deal with the latency of disk access.
- MySQL has it's advantages as the data is persistent. This helps if we ever need to restart the server.

### Bottlenecks
- The redis servers are the largest bottleneck. If there is a huge influx of traffic, you will need to add more redis instances to handle the amount of reads and counter updates.
- You will have to do this with sharding, shard the user ids and each redis instance will have a range of user ids to handle. 
- You will also need to have replication on each shard to ensure high availability.

### Summary
A rate-limiter is a simple application that allows us to limit the number of requests a user can send to our server.

We use the leaky bucket algorithm to track the number of requests, and redis to store/query data.